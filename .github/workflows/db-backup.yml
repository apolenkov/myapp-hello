---
name: DB Backup

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: Action to perform
        required: true
        type: choice
        options:
          - backup-now
          - setup-schedules

jobs:
  # ── Discover PostgreSQL instances via project.all ─────────────────────
  discover:
    name: Discover Databases
    runs-on: ubuntu-latest

    outputs:
      postgres-json: ${{ steps.list.outputs.postgres_json }}

    steps:
      - name: List PostgreSQL services
        id: list
        env:
          DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}
          DOKPLOY_TOKEN: ${{ secrets.DOKPLOY_TOKEN }}
        run: |
          RESPONSE=$(curl -sf \
            "$DOKPLOY_URL/api/trpc/project.all" \
            -H "x-api-key: $DOKPLOY_TOKEN")

          # Extract postgres instances from all environments
          PG_JSON=$(echo "$RESPONSE" | jq -c '
            [.result.data.json[].environments[].postgres[]
             | {postgresId, name, databaseName}]')
          COUNT=$(echo "$PG_JSON" | jq 'length')

          echo "Found $COUNT PostgreSQL instance(s)"
          echo "$PG_JSON" | jq '.[].name'
          echo "postgres_json=$PG_JSON" >> "$GITHUB_OUTPUT"

  # ── Manual / Scheduled Backup ─────────────────────────────────────────
  backup-now:
    name: Backup ${{ matrix.name }}
    needs: discover
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch'
       && inputs.action == 'backup-now')

    strategy:
      matrix:
        include: >-
          ${{ fromJSON(needs.discover.outputs.postgres-json) }}

    steps:
      - name: Find backup config
        id: find
        env:
          DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}
          DOKPLOY_TOKEN: ${{ secrets.DOKPLOY_TOKEN }}
        run: |
          PG_ID="${{ matrix.postgresId }}"
          INPUT=$(jq -nc --arg id "$PG_ID" \
            '{"json":{"postgresId":$id}}')

          RESP=$(curl -sf -G \
            "$DOKPLOY_URL/api/trpc/postgres.one" \
            --data-urlencode "input=$INPUT" \
            -H "x-api-key: $DOKPLOY_TOKEN")

          BACKUP_ID=$(echo "$RESP" | jq -r \
            '.result.data.json.backups[0].backupId // empty')

          if [ -z "$BACKUP_ID" ]; then
            echo "::error::No backup config for ${{ matrix.name }}"
            echo "Run 'setup-schedules' first to create configs"
            exit 1
          fi
          echo "backup_id=$BACKUP_ID" >> "$GITHUB_OUTPUT"

      - name: Trigger backup for ${{ matrix.name }}
        env:
          DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}
          DOKPLOY_TOKEN: ${{ secrets.DOKPLOY_TOKEN }}
        run: |
          BACKUP_ID="${{ steps.find.outputs.backup_id }}"
          PAYLOAD=$(jq -nc --arg id "$BACKUP_ID" \
            '{"json":{"backupId":$id}}')

          HTTP_CODE=$(curl -so /dev/null -w '%{http_code}' \
            "$DOKPLOY_URL/api/trpc/backup.manualBackupPostgres" \
            -H "x-api-key: $DOKPLOY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          if [ "$HTTP_CODE" -ge 200 ] \
             && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Backup triggered (HTTP $HTTP_CODE)"
          else
            echo "::error::Backup failed (HTTP $HTTP_CODE)"
            exit 1
          fi

  # ── Setup Backup Configs in Dokploy ──────────────────────────────────
  # Requires DOKPLOY_DESTINATION_ID secret (S3-compatible storage).
  # Create destination in Dokploy UI first, then add its ID as secret.
  setup-schedules:
    name: Setup Backup Schedules
    needs: discover
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch'
      && inputs.action == 'setup-schedules'

    steps:
      - name: Configure daily backups
        env:
          DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}
          DOKPLOY_TOKEN: ${{ secrets.DOKPLOY_TOKEN }}
          DESTINATION_ID: ${{ secrets.DOKPLOY_DESTINATION_ID }}
          POSTGRES_JSON: >-
            ${{ needs.discover.outputs.postgres-json }}
        run: |
          if [ -z "$DESTINATION_ID" ]; then
            echo "::error::DOKPLOY_DESTINATION_ID not set"
            echo "Create an S3 destination in Dokploy UI,"
            echo "then add its ID as a GitHub secret."
            exit 1
          fi

          echo "$POSTGRES_JSON" | jq -c '.[]' \
            | while read -r PG; do
            NAME=$(echo "$PG" | jq -r '.name')
            PG_ID=$(echo "$PG" | jq -r '.postgresId')
            DB=$(echo "$PG" | jq -r '.databaseName')

            echo "Setting up backup for $NAME (db: $DB)"

            PAYLOAD=$(jq -nc \
              --arg pid "$PG_ID" \
              --arg db "$DB" \
              --arg dst "$DESTINATION_ID" \
              --arg pfx "$NAME" \
              '{"json":{
                "postgresId":$pid,
                "schedule":"0 3 * * *",
                "database":$db,
                "prefix":$pfx,
                "destinationId":$dst,
                "databaseType":"postgres",
                "keepLatestCount":7,
                "enabled":true}}')

            RESP=$(curl -s -w "\n%{http_code}" \
              "$DOKPLOY_URL/api/trpc/backup.create" \
              -H "x-api-key: $DOKPLOY_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

            CODE=$(echo "$RESP" | tail -1)
            BODY=$(echo "$RESP" | sed '$d')

            if [ "$CODE" -ge 200 ] \
               && [ "$CODE" -lt 300 ]; then
              echo "Schedule created for $NAME"
            else
              echo "::warning::Failed for $NAME ($CODE)"
              echo "$BODY"
            fi
          done
