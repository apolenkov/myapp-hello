# Prometheus scrape configuration.
# Auto-discovers myapp containers via Docker SD and scrapes /metrics.

global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # ── Self-monitoring ───────────────────────────────────────────────────────
  - job_name: prometheus
    static_configs:
      - targets: ['localhost:9090']

  # ── Loki metrics ─────────────────────────────────────────────────────────
  - job_name: loki
    static_configs:
      - targets: ['loki:3100']

  # ── Tempo metrics ────────────────────────────────────────────────────────
  - job_name: tempo
    static_configs:
      - targets: ['tempo:3200']

  # ── Application metrics (Docker service discovery) ───────────────────────
  - job_name: myapp
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 15s
        filters:
          - name: name
            values: ['.*myapp.*']
    relabel_configs:
      # Replace target port with the app's internal port
      - source_labels: ['__address__']
        regex: '(.+):\d+'
        target_label: __address__
        replacement: '$1:3001'
      # Use container name as instance label
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: instance
      # Extract compose service
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service
    metrics_path: /metrics
    scheme: http
