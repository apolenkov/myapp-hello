---
# Ansible playbook: rotate PostgreSQL passwords
#
# Generates new passwords, applies them via Docker exec (ALTER USER),
# updates Dokploy env vars, and redeploys applications.
#
# Prerequisites:
#   - SSH access to VPS (ssh key in secrets.yml)
#   - Current secrets.yml with valid Dokploy credentials
#
# Usage:
#   ansible-playbook infra/ansible/rotate-db-passwords.yml \
#     -e @infra/ansible/vars/secrets.yml --ask-vault-pass
#
# Single environment:
#   ansible-playbook infra/ansible/rotate-db-passwords.yml \
#     -e @infra/ansible/vars/secrets.yml -e target_env=dev

- name: Rotate PostgreSQL passwords
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    target_env: all
    db_configs:
      prod:
        app_id: '{{ app_id_prod }}'
        postgres_id: '{{ postgres_id_prod }}'
        container_prefix: postgres-prod
        db_user: '{{ db_user_prod }}'
        db_name: '{{ db_name_prod }}'
        db_host: '{{ db_host_prod }}'
        jwt_secret: '{{ jwt_secret_prod }}'
        node_env: production
        log_level: warn
      staging:
        app_id: '{{ app_id_staging }}'
        postgres_id: '{{ postgres_id_staging }}'
        container_prefix: postgres-staging
        db_user: '{{ db_user_staging }}'
        db_name: '{{ db_name_staging }}'
        db_host: '{{ db_host_staging }}'
        jwt_secret: '{{ jwt_secret_staging }}'
        node_env: staging
        log_level: info
      dev:
        app_id: '{{ app_id_dev }}'
        postgres_id: '{{ postgres_id_dev }}'
        container_prefix: postgres-dev
        db_user: '{{ db_user_dev }}'
        db_name: '{{ db_name_dev }}'
        db_host: '{{ db_host_dev }}'
        jwt_secret: '{{ jwt_secret_dev }}'
        node_env: development
        log_level: debug
    health_urls:
      prod: https://apolenkov.duckdns.org
      staging: https://staging.apolenkov.duckdns.org
      dev: https://dev.apolenkov.duckdns.org

  tasks:
    - name: Determine target environments
      ansible.builtin.set_fact:
        target_envs: >-
          {{ [target_env] if target_env != 'all'
             else ['dev', 'staging', 'prod'] }}

    # ── Generate new passwords ──────────────────────────────────────────
    - name: Generate new passwords
      ansible.builtin.command:
        cmd: openssl rand -base64 32
      register: new_passwords
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      changed_when: false

    - name: Store new passwords
      ansible.builtin.set_fact:
        generated_passwords: >-
          {{ generated_passwords | default({}) | combine({
               item.item: item.stdout | trim
             }) }}
      loop: '{{ new_passwords.results }}'
      loop_control:
        label: '{{ item.item }}'

    - name: Show new passwords (save these!)
      ansible.builtin.debug:
        msg: |
          NEW PASSWORDS (update secrets.yml after rotation):
          {% for env in target_envs %}
            {{ env }}: {{ generated_passwords[env] }}
          {% endfor %}

          IMPORTANT: Update infra/ansible/vars/secrets.yml with new passwords!

    # ── Find Docker containers ──────────────────────────────────────────
    - name: Find PostgreSQL container names
      ansible.builtin.command:
        cmd: >-
          ssh -i {{ vps_ssh_key }} -o StrictHostKeyChecking=no
          root@{{ vps_host }}
          docker ps --filter "name={{ db_configs[item].container_prefix }}" --format "{% raw %}{{.Names}}{% endraw %}"
      register: container_names
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      changed_when: false

    - name: Store container names
      ansible.builtin.set_fact:
        containers: >-
          {{ containers | default({}) | combine({
               item.item: item.stdout_lines[0]
             }) }}
      loop: '{{ container_names.results }}'
      loop_control:
        label: '{{ item.item }}'

    # ── Change passwords in PostgreSQL ──────────────────────────────────
    - name: Change PostgreSQL password via ALTER USER
      ansible.builtin.command:
        cmd: >-
          ssh -i {{ vps_ssh_key }} -o StrictHostKeyChecking=no
          root@{{ vps_host }}
          docker exec {{ containers[item] }}
          psql -U {{ db_configs[item].db_user }} -d {{ db_configs[item].db_name }}
          -c "ALTER USER {{ db_configs[item].db_user }} WITH PASSWORD '{{ generated_passwords[item] }}';"
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      register: alter_results
      no_log: true

    - name: Verify ALTER USER results
      ansible.builtin.debug:
        msg: '{{ item.item }}: {{ "OK" if item.rc == 0 else "FAILED" }}'
      loop: '{{ alter_results.results }}'
      loop_control:
        label: '{{ item.item }}'

    # ── Update Dokploy env vars ─────────────────────────────────────────
    - name: Build new env strings
      ansible.builtin.set_fact:
        new_env_content: >-
          {{ new_env_content | default({}) | combine({
               item: 'NODE_ENV=' ~ db_configs[item].node_env ~ '\n'
                   ~ 'APP_NAME=myapp-hello\n'
                   ~ 'PORT=3001\n'
                   ~ 'DATABASE_URL=postgresql://' ~ db_configs[item].db_user ~ ':' ~ generated_passwords[item] ~ '@' ~ db_configs[item].db_host ~ ':5432/' ~ db_configs[item].db_name ~ '\n'
                   ~ 'JWT_SECRET=' ~ db_configs[item].jwt_secret ~ '\n'
                   ~ 'SENTRY_DSN=' ~ sentry_dsn ~ '\n'
                   ~ 'LOG_LEVEL=' ~ db_configs[item].log_level ~ '\n'
             }) }}
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'

    - name: Save new env vars to Dokploy
      ansible.builtin.uri:
        url: '{{ dokploy_url }}/api/trpc/application.saveEnvironment'
        method: POST
        headers:
          x-api-key: '{{ dokploy_token }}'
          Content-Type: application/json
        body_format: json
        body:
          json:
            applicationId: '{{ db_configs[item].app_id }}'
            env: '{{ new_env_content[item] }}'
            createEnvFile: true
        status_code: [200, 201]
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      no_log: true

    # ── Update Dokploy PostgreSQL metadata ──────────────────────────────
    - name: Update Dokploy postgres password metadata
      ansible.builtin.uri:
        url: '{{ dokploy_url }}/api/trpc/postgres.update'
        method: POST
        headers:
          x-api-key: '{{ dokploy_token }}'
          Content-Type: application/json
        body_format: json
        body:
          json:
            postgresId: '{{ db_configs[item].postgres_id }}'
            databasePassword: '{{ generated_passwords[item] }}'
        status_code: [200, 201]
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      no_log: true

    # ── Redeploy ────────────────────────────────────────────────────────
    - name: Redeploy applications
      ansible.builtin.uri:
        url: '{{ dokploy_url }}/api/trpc/application.deploy'
        method: POST
        headers:
          x-api-key: '{{ dokploy_token }}'
          Content-Type: application/json
        body_format: json
        body:
          json:
            applicationId: '{{ db_configs[item].app_id }}'
        status_code: [200, 201]
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'

    - name: Wait for deployments
      ansible.builtin.pause:
        seconds: 30
        prompt: 'Waiting 30s for deployments...'

    # ── Verify ──────────────────────────────────────────────────────────
    - name: Health check
      ansible.builtin.uri:
        url: '{{ health_urls[item] }}/v1'
        method: GET
        return_content: true
        status_code: [200]
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      register: health_results
      retries: 5
      delay: 10
      until: health_results is not failed

    - name: Show verification results
      ansible.builtin.debug:
        msg: '{{ item.item }}: db={{ item.json.db | default("unknown") }}'
      loop: '{{ health_results.results }}'
      loop_control:
        label: '{{ item.item }}'

    - name: Final reminder
      ansible.builtin.debug:
        msg: |
          Password rotation complete!

          IMPORTANT — update secrets.yml with new passwords:
          {% for env in target_envs %}
            db_password_{{ env }}: {{ generated_passwords[env] }}
          {% endfor %}

          Then re-encrypt:
            ansible-vault encrypt infra/ansible/vars/secrets.yml
