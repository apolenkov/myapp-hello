---
# Ansible playbook: rotate PostgreSQL passwords
#
# Generates new passwords, applies them via Docker exec (ALTER USER),
# updates Dokploy env vars, and redeploys applications.
#
# Prerequisites:
#   - SSH access to VPS (ssh key in secrets.yml)
#   - Current secrets.yml with valid Dokploy credentials
#
# Usage:
#   ansible-playbook infra/ansible/rotate-db-passwords.yml \
#     -e @infra/ansible/vars/secrets.yml --ask-vault-pass
#
# Single environment:
#   ansible-playbook infra/ansible/rotate-db-passwords.yml \
#     -e @infra/ansible/vars/secrets.yml -e target_env=dev

- name: Rotate PostgreSQL passwords
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    target_env: all
    resolved_otel_headers: >-
      {{ ('Authorization=Bearer ' ~ grafana_traces_write_token)
         if (grafana_traces_write_token is defined and grafana_traces_write_token.startswith('glc_'))
         else (('Authorization=Basic ' ~ ((grafana_stack_user ~ ':' ~ grafana_traces_write_token) | b64encode))
               if (grafana_stack_user is defined and grafana_traces_write_token is defined)
               else otel_headers) }}

    db_configs:
      prod:
        app_id: '{{ app_id_prod }}'
        postgres_id: '{{ postgres_id_prod }}'
        container_prefix: postgres-prod
        db_user: '{{ db_user_prod }}'
        db_name: '{{ db_name_prod }}'
        db_host: '{{ db_host_prod }}'
        jwt_secret: '{{ jwt_secret_prod }}'
        node_env: production
        log_level: warn
      staging:
        app_id: '{{ app_id_staging }}'
        postgres_id: '{{ postgres_id_staging }}'
        container_prefix: postgres-staging
        db_user: '{{ db_user_staging }}'
        db_name: '{{ db_name_staging }}'
        db_host: '{{ db_host_staging }}'
        jwt_secret: '{{ jwt_secret_staging }}'
        node_env: staging
        log_level: info
      dev:
        app_id: '{{ app_id_dev }}'
        postgres_id: '{{ postgres_id_dev }}'
        container_prefix: postgres-dev
        db_user: '{{ db_user_dev }}'
        db_name: '{{ db_name_dev }}'
        db_host: '{{ db_host_dev }}'
        jwt_secret: '{{ jwt_secret_dev }}'
        node_env: development
        log_level: debug
    health_urls:
      prod: https://apolenkov.duckdns.org
      staging: https://staging.apolenkov.duckdns.org
      dev: https://dev.apolenkov.duckdns.org

  tasks:
    - name: Determine target environments
      ansible.builtin.set_fact:
        target_envs: >-
          {{ [target_env] if target_env != 'all'
             else ['dev', 'staging', 'prod'] }}

    # ── Generate new passwords ──────────────────────────────────────────
    - name: Generate new passwords
      ansible.builtin.command:
        cmd: openssl rand -base64 32
      register: new_passwords
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      changed_when: false
      no_log: true

    - name: Store new passwords
      ansible.builtin.set_fact:
        generated_passwords: >-
          {{ generated_passwords | default({}) | combine({
               item.item: item.stdout | trim
             }) }}
      loop: '{{ new_passwords.results }}'
      loop_control:
        label: '{{ item.item }}'
      no_log: true

    - name: Save new passwords to file
      ansible.builtin.copy:
        dest: '/tmp/rotated-passwords-{{ ansible_date_time.iso8601_basic_short }}.txt'
        mode: '0600'
        content: |
          # Rotated passwords — {{ ansible_date_time.iso8601 }}
          # Update infra/ansible/vars/secrets.yml then re-encrypt.
          {% for env in target_envs %}
          db_password_{{ env }}: {{ generated_passwords[env] }}
          {% endfor %}
      no_log: true
      register: password_file

    # ── Find Docker containers ──────────────────────────────────────────
    - name: Find PostgreSQL container names
      ansible.builtin.command:
        cmd: >-
          ssh -i {{ vps_ssh_key }} -o StrictHostKeyChecking=accept-new
          root@{{ vps_host }}
          docker ps --filter "name={{ db_configs[item].container_prefix }}" --format "{% raw %}{{.Names}}{% endraw %}"
      register: container_names
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      changed_when: false
      no_log: true

    - name: Store container names
      ansible.builtin.set_fact:
        containers: >-
          {{ containers | default({}) | combine({
               item.item: item.stdout_lines[0]
             }) }}
      loop: '{{ container_names.results }}'
      loop_control:
        label: '{{ item.item }}'

    # ── Save old Dokploy env vars for rollback ─────────────────────────
    - name: Fetch current Dokploy env vars (for rollback)
      ansible.builtin.uri:
        url: '{{ dokploy_url }}/api/trpc/application.one?input={{ {"json": {"applicationId": db_configs[item].app_id}} | to_json | urlencode }}'
        method: GET
        headers:
          x-api-key: '{{ dokploy_token }}'
          Content-Type: application/json
        return_content: true
        status_code: [200]
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      register: old_app_state
      no_log: true

    - name: Store old env vars for rollback
      ansible.builtin.set_fact:
        old_env_vars: >-
          {{ old_env_vars | default({}) | combine({
               item.item: item.json.result.data.json.env | default('')
             }) }}
      loop: '{{ old_app_state.results }}'
      loop_control:
        label: '{{ item.item }}'
      no_log: true

    - name: Extract old passwords from DATABASE_URL for rollback
      ansible.builtin.set_fact:
        old_passwords: >-
          {{ old_passwords | default({}) | combine({
               item: old_env_vars[item]
                     | regex_search('DATABASE_URL=postgresql://[^:]+:([^@]+)@', '\1')
                     | first | default('')
             }) }}
      loop: '{{ target_envs }}'
      loop_control:
        label: '{{ item }}'
      no_log: true

    # ── Rotate passwords with rollback ─────────────────────────────────
    - name: Rotate passwords (block with rollback on failure)
      block:
        # ── Change passwords in PostgreSQL ────────────────────────────
        # Uses stdin pipe to avoid password exposure in process list.
        # The SQL is piped via shell heredoc so the password never
        # appears as a command-line argument visible in `ps aux`.
        - name: Change PostgreSQL password via ALTER USER
          ansible.builtin.shell:
            cmd: >-
              ssh -i {{ vps_ssh_key }} -o StrictHostKeyChecking=accept-new
              root@{{ vps_host }}
              'docker exec -i {{ containers[item] }}
              psql -U {{ db_configs[item].db_user }} -d {{ db_configs[item].db_name }}'
              <<< "ALTER USER {{ db_configs[item].db_user }} WITH PASSWORD '"'"'{{ generated_passwords[item] | replace("'", "''") }}'"'"';"
          args:
            executable: /bin/bash
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          register: alter_results
          no_log: true

        - name: Verify ALTER USER results
          ansible.builtin.assert:
            that: item.rc == 0
            fail_msg: 'ALTER USER failed for {{ item.item }}'
            success_msg: '{{ item.item }}: ALTER USER OK'
          loop: '{{ alter_results.results }}'
          loop_control:
            label: '{{ item.item }}'

        # ── Update Dokploy env vars ──────────────────────────────────
        - name: Build new env strings
          ansible.builtin.set_fact:
            new_env_content: >-
              {{ new_env_content | default({}) | combine({
                   item: 'NODE_ENV=' ~ db_configs[item].node_env ~ '\n'
                       ~ 'APP_NAME=myapp-hello\n'
                       ~ 'OTEL_SERVICE_NAME=myapp-hello\n'
                       ~ 'PORT=3001\n'
                       ~ 'SERVICE_NAMESPACE=my-application-group\n'
                       ~ 'DATABASE_URL=postgresql://' ~ db_configs[item].db_user ~ ':' ~ generated_passwords[item] ~ '@' ~ db_configs[item].db_host ~ ':5432/' ~ db_configs[item].db_name ~ '\n'
                       ~ 'JWT_SECRET=' ~ db_configs[item].jwt_secret ~ '\n'
                       ~ 'SENTRY_DSN=' ~ sentry_dsn ~ '\n'
                       ~ 'OTEL_EXPORTER_OTLP_ENDPOINT=' ~ otel_endpoint ~ '\n'
                       ~ 'OTEL_EXPORTER_OTLP_HEADERS=' ~ resolved_otel_headers ~ '\n'
                       ~ 'OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf\n'
                       ~ 'OTEL_RESOURCE_ATTRIBUTES=service.namespace=my-application-group\n'
                       ~ 'LOG_LEVEL=' ~ db_configs[item].log_level ~ '\n'
                 }) }}
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          no_log: true

        - name: Save new env vars to Dokploy
          ansible.builtin.uri:
            url: '{{ dokploy_url }}/api/trpc/application.saveEnvironment'
            method: POST
            headers:
              x-api-key: '{{ dokploy_token }}'
              Content-Type: application/json
            body_format: json
            body:
              json:
                applicationId: '{{ db_configs[item].app_id }}'
                env: '{{ new_env_content[item] }}'
                createEnvFile: true
            status_code: [200, 201]
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          no_log: true

        # ── Update Dokploy PostgreSQL metadata ────────────────────────
        - name: Update Dokploy postgres password metadata
          ansible.builtin.uri:
            url: '{{ dokploy_url }}/api/trpc/postgres.update'
            method: POST
            headers:
              x-api-key: '{{ dokploy_token }}'
              Content-Type: application/json
            body_format: json
            body:
              json:
                postgresId: '{{ db_configs[item].postgres_id }}'
                databasePassword: '{{ generated_passwords[item] }}'
            status_code: [200, 201]
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          no_log: true

        # ── Redeploy ─────────────────────────────────────────────────
        - name: Redeploy applications
          ansible.builtin.uri:
            url: '{{ dokploy_url }}/api/trpc/application.deploy'
            method: POST
            headers:
              x-api-key: '{{ dokploy_token }}'
              Content-Type: application/json
            body_format: json
            body:
              json:
                applicationId: '{{ db_configs[item].app_id }}'
            status_code: [200, 201]
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          no_log: true

        - name: Wait for deployments
          ansible.builtin.pause:
            seconds: 30
            prompt: 'Waiting 30s for deployments...'

        # ── Verify ───────────────────────────────────────────────────
        - name: Health check
          ansible.builtin.uri:
            url: '{{ health_urls[item] }}/v1'
            method: GET
            return_content: true
            status_code: [200]
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          register: health_results
          retries: 5
          delay: 10
          until: health_results is not failed

        - name: Show verification results
          ansible.builtin.debug:
            msg: '{{ item.item }}: db={{ item.json.db | default("unknown") }}'
          loop: '{{ health_results.results }}'
          loop_control:
            label: '{{ item.item }}'

      # ── Rollback on any failure ──────────────────────────────────────
      rescue:
        - name: 'ROLLBACK: Display failure details'
          ansible.builtin.debug:
            msg: >-
              Rotation failed. Starting rollback to restore old passwords
              for environments: {{ target_envs | join(', ') }}

        - name: 'ROLLBACK: Restore old PostgreSQL passwords'
          ansible.builtin.shell:
            cmd: >-
              ssh -i {{ vps_ssh_key }} -o StrictHostKeyChecking=accept-new
              root@{{ vps_host }}
              'docker exec -i {{ containers[item] }}
              psql -U {{ db_configs[item].db_user }} -d {{ db_configs[item].db_name }}'
              <<< "ALTER USER {{ db_configs[item].db_user }} WITH PASSWORD '"'"'{{ old_passwords[item] | replace("'", "''") }}'"'"';"
          args:
            executable: /bin/bash
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          register: rollback_alter
          no_log: true
          ignore_errors: true

        - name: 'ROLLBACK: Restore old Dokploy env vars'
          ansible.builtin.uri:
            url: '{{ dokploy_url }}/api/trpc/application.saveEnvironment'
            method: POST
            headers:
              x-api-key: '{{ dokploy_token }}'
              Content-Type: application/json
            body_format: json
            body:
              json:
                applicationId: '{{ db_configs[item].app_id }}'
                env: '{{ old_env_vars[item] }}'
                createEnvFile: true
            status_code: [200, 201]
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          no_log: true
          ignore_errors: true

        - name: 'ROLLBACK: Redeploy applications with old config'
          ansible.builtin.uri:
            url: '{{ dokploy_url }}/api/trpc/application.deploy'
            method: POST
            headers:
              x-api-key: '{{ dokploy_token }}'
              Content-Type: application/json
            body_format: json
            body:
              json:
                applicationId: '{{ db_configs[item].app_id }}'
            status_code: [200, 201]
          loop: '{{ target_envs }}'
          loop_control:
            label: '{{ item }}'
          no_log: true
          ignore_errors: true

        - name: 'ROLLBACK: Summary'
          ansible.builtin.debug:
            msg: |
              Rollback attempted for: {{ target_envs | join(', ') }}
              ALTER USER restore results:
              {% for r in rollback_alter.results %}
                {{ r.item }}: {{ 'OK' if r.rc == 0 else 'FAILED — manual intervention required' }}
              {% endfor %}

              Review the failure above, fix the issue, and re-run the playbook.
              The temp password file ({{ password_file.dest }}) still exists for reference.

        - name: 'ROLLBACK: Fail play after rollback'
          ansible.builtin.fail:
            msg: >-
              Password rotation failed and rollback was attempted.
              Check the rollback summary above for details.

    - name: Final reminder
      ansible.builtin.debug:
        msg: |
          Password rotation complete!
          New passwords saved to: {{ password_file.dest }}

          Next steps:
            1. Copy passwords from {{ password_file.dest }} into secrets.yml
            2. Re-encrypt: ansible-vault encrypt infra/ansible/vars/secrets.yml
            3. Delete the temp file: rm {{ password_file.dest }}
