- name: Restore from R2 backup
  hosts: vps
  vars_files: [../vars/vault.yml]
  tasks:
    - name: Find latest backup
      shell: rclone lsf r2:myapp-backups --dirs-only | sort | tail -1 | tr -d '/'
      register: latest_backup
      failed_when: latest_backup.stdout == ''

    - name: Download latest backup
      shell: rclone copy "r2:myapp-backups/{{ latest_backup.stdout }}" /tmp/restore/
      args:
        creates: /tmp/restore/postgres

    - name: Restore Dokploy config
      synchronize:
        src: /tmp/restore/configs/dokploy/
        dest: /etc/dokploy/
        delete: false

    - name: Restore PostgreSQL databases
      shell: |
        for SVC in prod staging dev; do
          CNAME=$(docker ps --filter name="pg-${SVC}" --format "{{.Names}}" | head -1)
          if [ -n "$CNAME" ] && [ -f "/tmp/restore/postgres/myapp_${SVC}.sql.gz" ]; then
            docker exec "$CNAME" psql -v ON_ERROR_STOP=1 -U postgres -c "DROP DATABASE IF EXISTS myapp_${SVC}"
            docker exec "$CNAME" psql -v ON_ERROR_STOP=1 -U postgres -c "CREATE DATABASE myapp_${SVC}"
            zcat "/tmp/restore/postgres/myapp_${SVC}.sql.gz" | \
              docker exec -i "$CNAME" psql -v ON_ERROR_STOP=1 -U postgres "myapp_${SVC}"
            echo "Restored: ${SVC}"
          fi
        done
