- name: Deploy observability stack (Loki + Promtail + Prometheus + Tempo + Grafana)
  hosts: vps
  vars_files:
    - ../vars/vault.yml

  tasks:
    - name: Create observability directory
      ansible.builtin.file:
        path: /opt/observability
        state: directory
        mode: '0755'

    - name: Copy observability configs
      ansible.posix.synchronize:
        src: ../../observability/
        dest: /opt/observability/
        delete: true
        recursive: true

    - name: Create .env for observability stack
      ansible.builtin.copy:
        dest: /opt/observability/.env
        mode: '0600'
        content: |
          GRAFANA_ADMIN_USER={{ grafana_admin_user | default('admin') }}
          GRAFANA_ADMIN_PASSWORD={{ grafana_admin_password }}
          GRAFANA_ROOT_URL={{ grafana_root_url | default('http://localhost:3100') }}
      no_log: true

    - name: Start observability stack
      community.docker.docker_compose_v2:
        project_src: /opt/observability
        files:
          - docker-compose.observability.yml
        state: present
        pull: always
      register: compose_result

    - name: Wait for Grafana health
      ansible.builtin.uri:
        url: http://localhost:3100/api/health
        status_code: 200
      retries: 10
      delay: 5
      register: grafana_health
      until: grafana_health.status == 200

    - name: Wait for Prometheus health
      ansible.builtin.uri:
        url: http://localhost:9090/-/healthy
        status_code: 200
      retries: 10
      delay: 5
      register: prometheus_health
      until: prometheus_health.status == 200

    - name: Print stack status
      ansible.builtin.debug:
        msg: >-
          Observability stack deployed.
          Grafana: http://{{ ansible_host }}:3100
          Prometheus: internal only (port 9090)
          Loki: internal only (port 3100)
          Tempo: internal only (port 3200/4318)
