- name: Deploy observability agents (Promtail + Alloy â†’ Grafana Cloud)
  hosts: vps
  vars_files:
    - ../vars/vault.yml

  tasks:
    - name: Create observability directory
      ansible.builtin.file:
        path: /opt/observability
        state: directory
        mode: '0755'

    - name: Copy observability configs
      ansible.posix.synchronize:
        src: ../../observability/
        dest: /opt/observability/
        delete: true
        recursive: true

    - name: Create .env for observability agents
      ansible.builtin.copy:
        dest: /opt/observability/.env
        mode: '0600'
        content: |
          GRAFANA_API_TOKEN={{ grafana_api_token }}
          GRAFANA_ORG_ID={{ grafana_org_id }}
          LOKI_USER_ID={{ loki_user_id }}
      no_log: true

    - name: Start observability agents
      community.docker.docker_compose_v2:
        project_src: /opt/observability
        files:
          - docker-compose.observability.yml
        state: present
        pull: always
      register: compose_result

    - name: Wait for Promtail readiness
      ansible.builtin.uri:
        url: http://localhost:9080/ready
        status_code: 200
      retries: 10
      delay: 5
      register: promtail_health
      until: promtail_health.status == 200

    - name: Wait for Alloy readiness
      ansible.builtin.uri:
        url: http://localhost:12345/-/ready
        status_code: 200
      retries: 10
      delay: 5
      register: alloy_health
      until: alloy_health.status == 200

    - name: Print stack status
      ansible.builtin.debug:
        msg: >-
          Observability agents deployed.
          Promtail: http://{{ ansible_host }}:9080/targets
          Alloy: http://{{ ansible_host }}:12345
          Telemetry pushed to Grafana Cloud.
